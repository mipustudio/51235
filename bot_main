import asyncio
import aiohttp
from datetime import datetime
from io import BytesIO

from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command, CommandStart
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage

from config import config, logger
from database import db

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å PIL
PIL_AVAILABLE = False
try:
    from PIL import Image, ImageFilter, ImageDraw, ImageFont
    PIL_AVAILABLE = True
    logger.info("‚úÖ PIL/Pillow –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
except ImportError as e:
    logger.warning(f"‚ö†Ô∏è PIL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {e}")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å GigaChat
GIGACHAT_AVAILABLE = False
gigachat_client = None
try:
    from gigachat import GigaChat
    from gigachat.models import Chat, Messages, MessagesRole
    GIGACHAT_AVAILABLE = True
    
    if config.GIGACHAT_CLIENT_ID and config.GIGACHAT_SECRET:
        try:
            gigachat_client = GigaChat(
                credentials=config.GIGACHAT_SECRET,
                scope=config.GIGACHAT_CLIENT_ID,
                verify_ssl_certs=False
            )
            logger.info("‚úÖ GigaChat –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GigaChat: {e}")
    else:
        logger.warning("‚ö†Ô∏è GigaChat –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç CLIENT_ID –∏–ª–∏ SECRET)")
except ImportError as e:
    logger.warning(f"‚ö†Ô∏è GigaChat –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {e}")

# ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
bot = Bot(token=config.TOKEN)
dp = Dispatcher(storage=MemoryStorage())

# ========== STATES (FSM) ==========
class PostStates(StatesGroup):
    waiting_for_topic = State()

class EventStates(StatesGroup):
    waiting_for_title = State()
    waiting_for_description = State()
    waiting_for_date = State()

# ========== MIDDLEWARE ==========
async def check_access_middleware(handler, event: Message, data: dict):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not event.from_user:
        return await handler(event, data)
    
    username = event.from_user.username or str(event.from_user.id)
    
    # –ê–¥–º–∏–Ω—ã –≤—Å–µ–≥–¥–∞ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø
    if event.from_user.id in config.ADMIN_IDS:
        logger.debug(f"–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {username}")
        return await handler(event, data)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ whitelist
    if db.is_whitelisted(username):
        logger.debug(f"–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {username}")
        return await handler(event, data)
    else:
        logger.warning(f"–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {username}")
        await event.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return

# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º middleware
dp.message.middleware.register(check_access_middleware)

# ========== –ö–û–ú–ê–ù–î–´ ==========
@dp.message(CommandStart())
async def start_command(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start"""
    welcome_text = """
ü§ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç!

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/admin - –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
/add user @username - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
/generate_post - —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç —á–µ—Ä–µ–∑ AI
/events - —Å–ø–∏—Å–æ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
/add_event - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
/media - –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –°–ú–ò
/help - –ø–æ–º–æ—â—å

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º!
"""
    await message.answer(welcome_text)

@dp.message(Command("help"))
async def help_command(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏"""
    await start_command(message)

@dp.message(Command("admin"))
async def admin_panel(message: Message):
    """–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"""
    if message.from_user.id not in config.ADMIN_IDS:
        await message.answer("‚õî –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤")
        return
    
    keyboard = [
        [types.InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")],
        [types.InlineKeyboardButton(text="üìù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è–º–∏", callback_data="admin_events")],
        [types.InlineKeyboardButton(text="üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫", callback_data="admin_restart")],
    ]
    
    markup = types.InlineKeyboardMarkup(inline_keyboard=keyboard)
    await message.answer("üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:", reply_markup=markup)

@dp.message(Command("add"))
async def add_to_whitelist(message: Message):
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ whitelist"""
    if message.from_user.id not in config.ADMIN_IDS:
        await message.answer("‚õî –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤")
        return
    
    args = message.text.split()
    if len(args) < 3:
        await message.answer("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /add user @username")
        return
    
    username = args[2].replace("@", "")
    if db.add_to_whitelist(username):
        await message.answer(f"‚úÖ @{username} –¥–æ–±–∞–≤–ª–µ–Ω –≤ whitelist")
    else:
        await message.answer(f"‚ÑπÔ∏è @{username} —É–∂–µ –≤ whitelist")

# ========== –û–ë–†–ê–ë–û–¢–ö–ê –§–û–¢–û ==========
@dp.message(F.photo)
async def process_photo(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ"""
    if not PIL_AVAILABLE:
        await message.answer("‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
        return
    
    try:
        await message.answer("üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–æ—Ç–æ...")
        
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–æ—Ç–æ
        photo = message.photo[-1]
        file = await bot.get_file(photo.file_id)
        photo_bytes = await bot.download_file(file.file_path)
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
        image = Image.open(BytesIO(photo_bytes.read()))
        image = image.filter(ImageFilter.SHARPEN)
        
        # –ü—Ä–æ—Å—Ç–æ–π –ª–æ–≥–æ—Ç–∏–ø
        draw = ImageDraw.Draw(image)
        try:
            font = ImageFont.truetype("arial.ttf", 40)
        except:
            font = ImageFont.load_default()
        
        text = "SARATOV"
        draw.text((20, 20), text, font=font, fill=(255, 255, 255, 200))
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
        output = BytesIO()
        image.save(output, format='JPEG', quality=90)
        output.seek(0)
        
        await message.answer_photo(
            types.BufferedInputFile(output.getvalue(), "processed.jpg"),
            caption="‚úÖ –§–æ—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ!"
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏")

# ========== –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–û–°–¢–û–í ==========
@dp.message(Command("generate_post"))
async def generate_post_start(message: Message, state: FSMContext):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞"""
    if not GIGACHAT_AVAILABLE or not gigachat_client:
        await message.answer("‚ùå –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")
        return
    
    await message.answer("üìù –í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –ø–æ—Å—Ç–∞:")
    await state.set_state(PostStates.waiting_for_topic)

@dp.message(PostStates.waiting_for_topic)
async def generate_post_process(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–º—ã –ø–æ—Å—Ç–∞"""
    try:
        await message.answer("ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –ø–æ—Å—Ç...")
        
        prompt = f"–ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É: {message.text}. –°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º –∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."
        
        response = gigachat_client.chat(
            Chat(messages=[Messages(role=MessagesRole.USER, content=prompt)])
        )
        
        post_text = response.choices[0].message.content
        await message.answer(f"üìã –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Å—Ç:\n\n{post_text}")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")
        await message.answer("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")
    
    await state.clear()

# ========== –ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø ==========
@dp.message(Command("events"))
async def show_events(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è"""
    events = db.get_events()
    
    if not events:
        await message.answer("üìÖ –ù–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π")
        return
    
    text = "üìÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:\n\n"
    for event in events[-5:]:
        text += f"‚Ä¢ {event.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}\n"
        text += f"  üìÖ {event.get('date', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}\n"
        text += f"  üìù {event.get('description', '')[:50]}...\n\n"
    
    await message.answer(text)

@dp.message(Command("add_event"))
async def add_event_start(message: Message, state: FSMContext):
    """–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ"""
    await message.answer("üìù –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:")
    await state.set_state(EventStates.waiting_for_title)

@dp.message(EventStates.waiting_for_title)
async def add_event_title(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è"""
    await state.update_data(title=message.text)
    await message.answer("üìÑ –í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ:")
    await state.set_state(EventStates.waiting_for_description)

@dp.message(EventStates.waiting_for_description)
async def add_event_description(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è"""
    await state.update_data(description=message.text)
    await message.answer("üìÖ –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É (–î–î.–ú–ú.–ì–ì–ì–ì):")
    await state.set_state(EventStates.waiting_for_date)

@dp.message(EventStates.waiting_for_date)
async def add_event_date(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—ã"""
    data = await state.get_data()
    data["date"] = message.text
    data["creator"] = message.from_user.username or str(message.from_user.id)
    
    db.add_event(data)
    await message.answer("‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ")
    await state.clear()

# ========== –°–ú–ò ==========
@dp.message(Command("media"))
async def search_media(message: Message):
    """–ü–æ–∏—Å–∫ –°–ú–ò"""
    media_list = db.search_media("")
    
    if not media_list:
        await message.answer("üì∞ –ë–∞–∑–∞ –°–ú–ò –ø—É—Å—Ç–∞")
        return
    
    text = "üì∞ –°–ú–ò –°–∞—Ä–∞—Ç–æ–≤–∞:\n\n"
    for media in media_list[-10:]:
        text += f"‚Ä¢ {media.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n"
        if media.get('description'):
            text += f"  {media.get('description')[:60]}...\n"
        text += "\n"
    
    await message.answer(text)

# ========== CALLBACKS ==========
@dp.callback_query(F.data.startswith("admin_"))
async def handle_admin_callback(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏–π"""
    action = callback.data
    
    if action == "admin_stats":
        events = len(db.get_events())
        await callback.message.answer(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n‚Ä¢ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π: {events}")
    
    elif action == "admin_events":
        await callback.message.answer("üìù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è–º–∏:\n/events - —Å–ø–∏—Å–æ–∫\n/add_event - –¥–æ–±–∞–≤–∏—Ç—å")
    
    elif action == "admin_restart":
        if not config.BOT_ID:
            await callback.message.answer("‚ùå BOT_ID –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(
                    f"{config.get_agent_url()}/api/bots/self/restart",
                    headers={'X-Bot-ID': config.BOT_ID},
                    timeout=10
                ) as resp:
                    result = await resp.json()
                    if result.get('ok'):
                        await callback.message.answer("‚úÖ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
                    else:
                        await callback.message.answer(f"‚ùå {result.get('msg')}")
        except Exception as e:
            await callback.message.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}")
    
    await callback.answer()
